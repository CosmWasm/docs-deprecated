<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="search" type="application/opensearchdescription+xml" title="CosmWasm Documentation" href="/opensearch.xml"><title data-react-helmet="true">Contract Semantics | CosmWasm Documentation</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://docs.cosmwasm.com/docs/1.0/smart-contracts/contract-semantics"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-docs-current"><meta data-react-helmet="true" property="og:title" content="Contract Semantics | CosmWasm Documentation"><meta data-react-helmet="true" name="description" content="This document aims to clarify the semantics of how a CosmWasm contract interacts"><meta data-react-helmet="true" property="og:description" content="This document aims to clarify the semantics of how a CosmWasm contract interacts"><link data-react-helmet="true" rel="icon" href="/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://docs.cosmwasm.com/docs/1.0/smart-contracts/contract-semantics"><link data-react-helmet="true" rel="alternate" href="https://docs.cosmwasm.com/docs/1.0/smart-contracts/contract-semantics" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.cosmwasm.com/fr/docs/1.0/smart-contracts/contract-semantics" hreflang="fr"><link data-react-helmet="true" rel="alternate" href="https://docs.cosmwasm.com/docs/1.0/smart-contracts/contract-semantics" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.293cb3ed.css">
<link rel="preload" href="/assets/js/runtime~main.417d6763.js" as="script">
<link rel="preload" href="/assets/js/main.d52e5be7.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?e("light"):e("dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_aKYr"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://docs.cosmwasm.com/" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/img/logo.svg" alt="CosmWasm" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo_dark.svg" alt="CosmWasm" class="themedImage_W2Cr themedImage--dark_oUvU"></div></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/1.0/">Docs</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" class="navbar__link">Learn</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/dev-academy/intro">Dev Academy</a></li><li><a class="dropdown__link" href="/tutorials/hijack-escrow/intro">Tutorials</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" class="navbar__link">dApps</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cw-plus/0.9.0/overview">cw-plus</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" class="navbar__link" docspluginid="ecosystem">Ecosystem</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/ecosystem/overview">Overview</a></li><li><a class="dropdown__link" href="/ecosystem/jobs">Jobs</a></li><li><a class="dropdown__link" href="/ecosystem/testnets/build-requirements">Testnets</a></li><li><a class="dropdown__link" href="/ecosystem/hall-of-fame">Hall of Fame</a></li><li><a class="dropdown__link" href="/ecosystem/media/assets">Media</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" href="/docs/1.0/">1.0</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/1.0/smart-contracts/contract-semantics">1.0</a></li><li><a class="dropdown__link" href="/docs/0.16/">0.16</a></li><li><a class="dropdown__link" href="/docs/0.14/">0.14</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_dNtB"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/docs/1.0/smart-contracts/contract-semantics" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">English</a></li><li><a href="/fr/docs/1.0/smart-contracts/contract-semantics" target="_self" rel="noopener noreferrer" class="dropdown__link">FranÃ§ais</a></li></ul></div><div class="toggle_Pssr toggle_TdHA toggleChecked_cnQY toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" checked="" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y sidebarWithHideableNavbar_FoYL"><a href="https://docs.cosmwasm.com/" target="_blank" rel="noopener noreferrer" tabindex="-1" class="sidebarLogo_FJUI"><img src="/img/logo.svg" alt="CosmWasm" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo_dark.svg" alt="CosmWasm" class="themedImage_W2Cr themedImage--dark_oUvU"></a><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/1.0/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/1.0/getting-started/intro">Getting Started</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/getting-started/intro">Your First Contract</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/getting-started/installation">Installation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/getting-started/setting-env">Setting Up Environment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/getting-started/compile-contract">Downloading and Compiling Contract</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/getting-started/interact-with-contract">Uploading and Interacting</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/getting-started/next-steps">Next Steps</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/1.0/architecture/multichain">Architecture</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/architecture/multichain">What are Multi-Chain Contracts?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/architecture/actor">Actor Model</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/architecture/addresses">Names and Addresses</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/architecture/query">Querying</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/architecture/serialization">Serialization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/architecture/composition">Contract Composition</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/architecture/smart-contracts">Comparison with Solidity Contracts</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" href="/docs/1.0/smart-contracts/contract-semantics">Smart Contracts</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/1.0/smart-contracts/contract-semantics">Contract Semantics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/result-option">Result and Option</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" tabindex="0" href="/docs/1.0/smart-contracts/message/message">Message</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" tabindex="0" href="/docs/1.0/smart-contracts/state/cw-plus">State</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/entry-points">Entry points</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/query">Query</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/events">Events</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/math">Math</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/compilation">Compilation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/deployment">Deployment</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" tabindex="0" href="/docs/1.0/smart-contracts/frontend_app/introduction">Frontend App</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/verify">Verifying Smart Contracts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/migration">Migration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/code-pinning">Code Pinning</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/testing">Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/sudo">Sudo Execution</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/1.0/integration">Integration</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/1.0/actor-model/idea">Actor model</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/actor-model/idea">Idea behind an Actor Model</a></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_cwdi"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_xORG"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><span class="theme-doc-version-badge badge badge--secondary">Version: <!-- -->1.0</span><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Contract Semantics</h1><p>This document aims to clarify the semantics of how a CosmWasm contract interacts
with its environment. There are two main types of actions: <em>mutating</em> actions,
which receive <code>DepsMut</code> and are able to modify the state of the blockchain, and
<em>query</em> actions, which are run on a single node with read-only access to the
data.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="execution">Execution<a class="hash-link" href="#execution" title="Direct link to heading">â€‹</a></h2><p>In the section below, we will discuss how the <code>execute</code> call works, but the same
semantics apply to any other <em>mutating</em> action - <code>instantiate</code>, <code>migrate</code>,
<code>sudo</code>, etc.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="sdk-context">SDK Context<a class="hash-link" href="#sdk-context" title="Direct link to heading">â€‹</a></h3><p>Before looking at CosmWasm, we should look at the (somewhat under-documented)
semantics enforced by the blockchain framework we integrate with - the
<a href="https://v1.cosmos.network/sdk" target="_blank" rel="noopener noreferrer">Cosmos SDK</a>. It is based upon the
<a href="https://tendermint.com/core/" target="_blank" rel="noopener noreferrer">Tendermint BFT</a> Consensus Engine. Let us first
look how they process transactions before they arrive in CosmWasm (and after
they leave).</p><p>First, the Tendermint engine will seek 2/3+ consensus on a list of transactions
to be included in the next block. This is done <em>without executing them</em>. They
are simply subjected to a minimal pre-filter by the Cosmos SDK module, to ensure
they are validly formatted transactions, with sufficient gas fees, and signed by
an account with sufficient fees to pay it. Notably, this means many transactions
that error may be included in a block.</p><p>Once a block is committed (typically every 5s or so), the transactions are then
fed to the Cosmos SDK sequentially in order to execute them. Each one returns a
result or error along with event logs, which are recorded in the <code>TxResults</code>
section of the next block. The <code>AppHash</code> (or merkle proof or blockchain state)
after executing the block is also included in the next block.</p><p>The Cosmos SDK <code>BaseApp</code> handles each transaction in an isolated context. It
first verifies all signatures and deducts the gas fees. It sets the &quot;Gas Meter&quot;
to limit the execution to the amount of gas paid for by the fees. Then it makes
an isolated context to run the transaction. This allows the code to read the
current state of the chain (after the last transaction finished), but it only
writes to a cache, which may be committed or rolled back on error.</p><p>A transaction may consist of multiple messages and each one is executed in turn
under the same context and same gas limit. If all messages succeed, the context
will be committed to the underlying blockchain state and the results of all
messages will be stored in the <code>TxResult</code>. If one message fails, all later
messages are skipped and all state changes are reverted. This is very important
for atomicity. That means Alice and Bob can both sign a transaction with 2
messages: Alice pays Bob 1000 ATOM, Bob pays Alice 50 ETH, and if Bob doesn&#x27;t
have the funds in his account, Alice&#x27;s payment will also be reverted. This is
just like a DB Transaction typically works.</p><p><a href="https://github.com/CosmWasm/wasmd/tree/master/x/wasm" target="_blank" rel="noopener noreferrer"><code>x/wasm</code></a> is a custom
Cosmos SDK module, which processes certain messages and uses them to upload,
instantiate, and execute smart contracts. In particular, it accepts a properly
signed
<a href="https://github.com/CosmWasm/wasmd/blob/v0.23.0/proto/cosmwasm/wasm/v1/tx.proto#L73-L86" target="_blank" rel="noopener noreferrer"><code>MsgExecuteContract</code></a>,
routes it to
<a href="https://github.com/CosmWasm/wasmd/blob/v0.23.0/x/wasm/keeper/keeper.go#L328-L369" target="_blank" rel="noopener noreferrer"><code>Keeper.Execute</code></a>,
which loads the proper smart contract and calls <code>execute</code> on it. Note that this
method may either return a success (with data and events) or an error. In the
case of an error here, it will revert the entire transaction in the block. This
is the context we find ourselves in when our contract receives the <code>execute</code>
call.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="basic-execution">Basic Execution<a class="hash-link" href="#basic-execution" title="Direct link to heading">â€‹</a></h3><p>When we implement a contract, we provide the following entry point:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn execute(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    deps: DepsMut,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    env: Env,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    info: MessageInfo,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    msg: ExecuteMsg,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">) -&gt; Result&lt;Response, ContractError&gt; { }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>With <code>DepsMut</code>, this can read and write to the backing <code>Storage</code>, as well as use
the <code>Api</code> to validate addresses, and <code>Query</code> the state of other contracts or
native modules. Once it is done, it returns either <code>Ok(Response)</code> or
<code>Err(ContractError)</code>. Let&#x27;s examine what happens next:</p><p>If it returns <code>Err</code>, this error is converted to a string representation
(<code>err.to_string()</code>), and this is returned to the SDK module. <em>All state changes
are reverted</em> and <code>x/wasm</code> returns this error message, which will <em>generally</em>
(see submessage exception below) abort the transaction, and return this same
error message to the external caller.</p><p>If it returns <code>Ok</code>, the <code>Response</code> object is parsed and processed. Let&#x27;s look at
the parts here:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct Response&lt;T = Empty&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">where</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    T: Clone + fmt::Debug + PartialEq + JsonSchema,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Optional list of &quot;subcalls&quot; to make. These will be executed in order</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// (and this contract&#x27;s subcall_response entry point invoked)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// *before* any of the &quot;fire and forget&quot; messages get executed.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pub submessages: Vec&lt;SubMsg&lt;T&gt;&gt;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// After any submessages are processed, these are all dispatched in the host blockchain.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// If they all succeed, then the transaction is committed. If any fail, then the transaction</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// and any local contract state changes are reverted.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pub messages: Vec&lt;CosmosMsg&lt;T&gt;&gt;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// The attributes that will be emitted as part of a &quot;wasm&quot; event</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pub attributes: Vec&lt;Attribute&gt;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pub data: Option&lt;Binary&gt;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In the Cosmos SDK, a transaction returns a number of events to the user, along
with an optional data &quot;result&quot;. This result is hashed into the next block hash
to be provable and can return some essential state (although in general client
apps rely on Events more). This result is more commonly used to pass results
between contracts or modules in the sdk. Note that the <code>ResultHash</code> includes
only the <code>Code</code> (non-zero meaning error) and <code>Result</code> (data) from the
transaction. Events and log are available via queries, but there are no
light-client proofs possible.</p><p>If the contract sets <code>data</code>, this will be returned in the <code>result</code> field.
<code>attributes</code> is a list of <code>{key, value}</code> pairs which will be
<a href="https://github.com/CosmWasm/wasmd/blob/master/x/wasm/types/types.go#L302-L321" target="_blank" rel="noopener noreferrer">appended to a default event</a>.
The final result looks like this to the client:</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;wasm&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token property">&quot;attributes&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token property">&quot;key&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;contract_addr&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;cosmos1234567890qwerty&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token property">&quot;key&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;custom-key-1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;custom-value-1&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token property">&quot;key&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;custom-key-2&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;custom-value-2&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="dispatching-messages">Dispatching Messages<a class="hash-link" href="#dispatching-messages" title="Direct link to heading">â€‹</a></h3><p>Now let&#x27;s move onto the <code>messages</code> field. Some contracts are fine only talking
with themselves, such as a cw20 contract just adjusting its balances on
transfers. But many want to move tokens (native or cw20) or call into other
contracts for more complex actions. This is where messages come in. We return
<a href="https://github.com/CosmWasm/cosmwasm/blob/v0.14.0-beta4/packages/std/src/results/cosmos_msg.rs#L18-L40" target="_blank" rel="noopener noreferrer"><code>CosmosMsg</code>, which is a serializable representation</a>
of any external call the contract can make. It looks something like this (with
<code>stargate</code> feature flag enabled):</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub enum CosmosMsg&lt;T = Empty&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">where</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    T: Clone + fmt::Debug + PartialEq + JsonSchema,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Bank(BankMsg),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// This can be defined by each blockchain as a custom extension</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Custom(T),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Staking(StakingMsg),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Distribution(DistributionMsg),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Stargate {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        type_url: String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        value: Binary,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Ibc(IbcMsg),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Wasm(WasmMsg),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If a contract returns two messages - M1 and M2, these will both be parsed and
executed in <code>x/wasm</code> <em>with the permissions of the contract</em> (meaning
<code>info.sender</code> will be the contract not the original caller). If they return
success, they will emit a new event with the custom attributes, the <code>data</code> field
will be ignored, and any messages they return will also be processed. If they
return an error, the parent call will return an error, thus rolling back state
of the whole transaction.</p><p>Note that the messages are executed <em>depth-first</em>. This means if contract A
returns M1 (<code>WasmMsg::Execute</code>) and M2 (<code>BankMsg::Send</code>), and contract B (from
the <code>WasmMsg::Execute</code>) returns N1 and N2 (eg. <code>StakingMsg</code> and
<code>DistributionMsg</code>), the order of execution would be <strong>M1, N1, N2, M2</strong>.</p><p>This may be hard to understand at first. &quot;Why can&#x27;t I just call another
contract?&quot;, you may ask. However, we do this to prevent one of most widespread
and hardest to detect security holes in Ethereum contracts - reentrancy. We do
this by following the actor model, which doesn&#x27;t nest function calls, but
returns messages that will be executed later. This means all state that is
carried over between one call and the next happens in storage and not in memory.
For more information on this design, I recommend you read
<a href="https://docs.cosmwasm.com/docs/1.0/architecture/actor" target="_blank" rel="noopener noreferrer">our docs on the Actor Model</a>.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="submessages">Submessages<a class="hash-link" href="#submessages" title="Direct link to heading">â€‹</a></h3><p>As of CosmWasm 0.14 (April 2021), we have added yet one more way to dispatch
calls from the contract. A common request was the ability to get the result from
one of the messages you dispatched. For example, you want to create a new
contract with <code>WasmMsg::Instantiate</code>, but then you need to store the address of
the newly created contract in the caller. With <code>submessages</code>, this is now
possible. It also solves a similar use-case of capturing the error results, so
if you execute a message from eg. a cron contract, it can store the error
message and mark the message as run, rather than aborting the whole transaction.
It also allows for limiting the gas usage of the submessage (this is not
intended to be used for most cases, but is needed for eg. the cron job to
protect it from an infinite loop in the submessage burning all gas and aborting
the transaction).</p><p>This makes use of <code>CosmosMsg</code> as above, but it wraps it inside a <code>SubMsg</code>
envelope:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct SubMsg&lt;T = Empty&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">where</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    T: Clone + fmt::Debug + PartialEq + JsonSchema,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pub id: u64,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pub msg: CosmosMsg&lt;T&gt;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pub gas_limit: Option&lt;u64&gt;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pub reply_on: ReplyOn,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub enum ReplyOn {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Always perform a callback after SubMsg is processed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Always,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Only callback if SubMsg returned an error, no callback on success case</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Error,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// Only callback if SubMsg was successful, no callback on error case</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Success,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>What are the semantics of a submessage execution. First, we create a
sub-transaction context around the state, allowing it to read the latest state
written by the caller, but write to yet-another cache. If <code>gas_limit</code> is set, it
is sandboxed to how much gas it can use until it aborts with <code>OutOfGasError</code>.
This error is caught and returned to the caller like any other error returned
from contract execution (unless it burned the entire gas limit of the
transaction). What is more interesting is what happens on completion.</p><p>If it return success, the temporary state is committed (into the caller&#x27;s
cache), and the <code>Response</code> is processed as normal (an event is added to the
current EventManager, messages and submessages are executed). Once the
<code>Response</code> is fully processed, this may then be intercepted by the calling
contract (for <code>ReplyOn::Always</code> and <code>ReplyOn::Success</code>). On an error, the
subcall will revert any partial state changes due to this message, but not
revert any state changes in the calling contract. The error may then be
intercepted by the calling contract (for <code>ReplyOn::Always</code> and
<code>ReplyOn::Error</code>). <em>In this case, the messages error doesn&#x27;t abort the whole
transaction</em></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="handling-the-reply">Handling the Reply<a class="hash-link" href="#handling-the-reply" title="Direct link to heading">â€‹</a></h4><p>In order to make use of <code>submessages</code>, the calling contract must have an extra
entry point:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[entry_point]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn reply(deps: DepsMut, env: Env, msg: Reply) -&gt; Result&lt;Response, ContractError&gt; { }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct Reply {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pub id: u64,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    /// ContractResult is just a nicely serializable version of `Result&lt;SubcallResponse, String&gt;`</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pub result: ContractResult&lt;SubcallResponse&gt;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct SubcallResponse {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pub events: Vec&lt;Event&gt;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pub data: Option&lt;Binary&gt;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>After the <code>submessage</code> is finished, the caller will get a chance to handle the
result. It will get the original <code>id</code> of the subcall so it can switch on how to
process this, and the <code>Result</code> of the execution, both success and error. Note
that it includes all events returned by the submessage, which applies to native
sdk modules as well (like Bank) as well as the data returned from below. This
and the original call id provide all context to continue processing it. If you
need more state, you must save some local context to the store (under the <code>id</code>)
before returning the <code>submessage</code> in the original <code>execute</code>, and load it in
<code>reply</code>. We explicitly prohibit passing information in contract memory, as that
is the key vector for reentrancy attacks, which are a large security surface
area in Ethereum.</p><p>The <code>reply</code> call may return <code>Err</code> itself, in which case it is treated like the
caller errored, and aborting the transaction. However, on successful processing,
<code>reply</code> may return a normal <code>Response</code>, which will be processed as normal -
events added to the EventManager, and all <code>messages</code> and <code>submessages</code>
dispatched as described above.</p><p>The one <em>critical difference</em> with <code>reply</code>, is that we <em>do not drop data</em>. If
<code>reply</code> returns <code>data: Some(value)</code> in the <code>Response</code> object, we will overwrite
the <code>data</code> field returned by the caller. That is, if <code>execute</code> returns
<code>data: Some(b&quot;first thought&quot;)</code> and the <code>reply</code> (with all the extra information
it is privy to) returns <code>data: Some(b&quot;better idea&quot;)</code>, then this will be returned
to the caller of <code>execute</code> (either the client or another transaction), just as
if the original <code>execute</code> and returned <code>data: Some(b&quot;better idea&quot;)</code>. If <code>reply</code>
returns <code>data: None</code>, it will not modify any previously set data state. If there
are multiple submessages all setting this, only the last one is used (they all
overwrite any previous <code>data</code> value). As a consequence, you can use
<code>data: Some(b&quot;&quot;)</code> to clear previously set data. This will be represented as a
JSON string instead of <code>null</code> and handled as any other <code>Some</code> value.</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="order-and-rollback">Order and Rollback<a class="hash-link" href="#order-and-rollback" title="Direct link to heading">â€‹</a></h4><p>Submessages (and their replies) are all executed before any <code>messages</code>. They
also follow the <em>depth first</em> rules as with <code>messages</code>. Here is a simple
example. Contract A returns submessages S1 and S2, and message M1. Submessage S1
returns message N1. The order will be: <strong>S1, N1, reply(S1), S2, reply(S2), M1</strong></p><p>Please keep in mind that submessage <code>execution</code> and <code>reply</code> can happen within
the context of another submessage. For example
<code>contract-A--submessage --&gt; contract-B--submessage --&gt; contract-C</code>. Then
<code>contract-B</code> can revert the state for <code>contract-C</code> and itself by returning <code>Err</code>
in the submessage <code>reply</code>, but not revert contract-A or the entire transaction.
It just ends up returning <code>Err</code> to contract-A&#x27;s <code>reply</code> function.</p><p>Note that errors are not handled with <code>ReplyOn::Success</code>, meaning, in such a
case, an error will be treated just like a normal <code>message</code> returning an error.
This diagram may help explain. Imagine a contract returned two submesssage - (a)
with <code>ReplyOn::Success</code> and (b) with <code>ReplyOn::Error</code>:</p><table><thead><tr><th>processing a)</th><th>processing b)</th><th>reply called</th><th>may overwrite result from reply</th><th>note</th></tr></thead><tbody><tr><td>ok</td><td>ok</td><td>a)</td><td>a)</td><td>returns success</td></tr><tr><td>err</td><td>err</td><td>none</td><td>none</td><td>returns error (abort parent transaction)</td></tr><tr><td>err</td><td>ok</td><td>none</td><td>none</td><td>returns error (abort parent transaction)</td></tr><tr><td>ok</td><td>err</td><td>a)b)</td><td>a)b)</td><td>if both a) and b) overwrite, only b) will be used</td></tr></tbody></table><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="query-semantics">Query Semantics<a class="hash-link" href="#query-semantics" title="Direct link to heading">â€‹</a></h2><p>Until now, we have focused on the <code>Response</code> object, which allows us to execute
code in other contracts via the actor model. That is, each contract is run
sequentially, one after another, and no nested calls are possible. This is
essential to avoid reentrancy, which is when calling into another contract can
change my state while I am in the middle of a transaction.</p><p>However, there are many times we need access to information from other contracts
in the middle of processing, such as determining the contract&#x27;s bank balance
before sending funds. To enable this, we have exposed the <em>read only</em> <code>Querier</code>
to enable <em>synchronous</em> calls in the middle of the execution. By making it
read-only (and enforcing that in the VM level), we can prevent the possibility
of reentrancy, as the query cannot modify any state or execute our contract.</p><p>When we &quot;make a query&quot;, we serialize a
<a href="https://github.com/CosmWasm/cosmwasm/blob/v0.14.0-beta4/packages/std/src/query/mod.rs#L27-L48" target="_blank" rel="noopener noreferrer"><code>QueryRequest</code> struct</a>
that represents all possible calls, and then pass that over FFI to the runtime,
where it is interpretted in the <code>x/wasm</code> SDK module. This is extensible with
blockchain-specific custom queries just like <code>CosmosMsg</code> accepts custom results.
Also note the ability to perform raw protobuf &quot;Stargate&quot; queries:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub enum QueryRequest&lt;C: CustomQuery&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Bank(BankQuery),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Custom(C),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Staking(StakingQuery),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Stargate {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        /// this is the fully qualified service path used for routing,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        /// eg. custom/cosmos_sdk.x.bank.v1.Query/QueryBalance</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        path: String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        /// this is the expected protobuf message type (not any), binary encoded</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        data: Binary,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Ibc(IbcQuery),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Wasm(WasmQuery),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>While this is flexible and needed encoding for the cross-language
representation, this is a bit of mouthful to generate and use when I just want
to find my bank balance. To help that, we often use
<a href="https://github.com/CosmWasm/cosmwasm/blob/v0.14.0-beta4/packages/std/src/traits.rs#L148-L314" target="_blank" rel="noopener noreferrer"><code>QuerierWrapper</code></a>,
which wraps a <code>Querier</code> and exposes a lot of convenience methods that just use
<code>QueryRequest</code> and <code>Querier.raw_query</code> under the hood.</p><p>You can read a longer explanation of the
<a href="https://docs.cosmwasm.com/docs/1.0/architecture/query" target="_blank" rel="noopener noreferrer"><code>Querier</code> design in our docs</a>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/InterWasm/docs/edit/main/docs/04-smart-contracts/01-contract-semantics.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/1.0/architecture/smart-contracts"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Comparison with Solidity Contracts</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/1.0/smart-contracts/result-option"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Result and Option</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#execution" class="table-of-contents__link toc-highlight">Execution</a><ul><li><a href="#sdk-context" class="table-of-contents__link toc-highlight">SDK Context</a></li><li><a href="#basic-execution" class="table-of-contents__link toc-highlight">Basic Execution</a></li><li><a href="#dispatching-messages" class="table-of-contents__link toc-highlight">Dispatching Messages</a></li><li><a href="#submessages" class="table-of-contents__link toc-highlight">Submessages</a></li></ul></li><li><a href="#query-semantics" class="table-of-contents__link toc-highlight">Query Semantics</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Related Documentation</div><ul class="footer__items"><li class="footer__item"><a href="https://cosmos.network/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Cosmos SDK<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://hub.cosmos.network/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Cosmos Hub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://docs.tendermint.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Tendermint Core<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Repositories</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/CosmWasm/cosmwasm" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>CosmWasm/cosmwasm<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/CosmWasm/wasmd" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>CosmWasm/wasmd<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/CosmWasm/cw-plus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>CosmWasm/cw-plus<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/InterWasm/cw-contracts" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>InterWasm/cw-contracts<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/InterWasm/cw-awesome" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>InterWasm/cw-awesome<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://medium.com/cosmwasm" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://docs.cosmwasm.com/chat/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/CosmWasm" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/InterWasm" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>InterWasm<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://cosmwasm.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_RC3H"><img src="/img/logo_stacked.png" alt="CosmWasm Logo" class="themedImage_W2Cr themedImage--light_TfLj footer__logo"><img src="/img/logo_stacked.png" alt="CosmWasm Logo" class="themedImage_W2Cr themedImage--dark_oUvU footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2022 CosmWasm</div></div></div></footer></div>
<script src="/assets/js/runtime~main.417d6763.js"></script>
<script src="/assets/js/main.d52e5be7.js"></script>
</body>
</html>